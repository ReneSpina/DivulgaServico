@model IEnumerable<DIVULGA_SERVICOS.Models.CAD_PES_ENDERECO>
@using System.Data.Entity.Spatial
@using Microsoft.AspNet.Identity

@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Busca Serviços</title>
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")

</head>

<body>

    <div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a><br />
        @if (Request.IsAuthenticated)
        {

            using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm", @class = "navbar-right" }))
            {
                @Html.AntiForgeryToken()
                @Html.ActionLink("Olá " + User.Identity.GetUserName() + "!", "Index", "Manage", routeValues: null, htmlAttributes: new { title = "Manage" })<br /><br />
                @Html.ActionLink("Mapa de Busca", "Index", "CAD_PES_JURIDICA")<br />
                @Html.ActionLink("Sobre", "About", "Home")<br />
                @Html.ActionLink("Contatos", "Contact", "Home")<br />
                <a href="javascript:document.getElementById('logoutForm').submit()">Log off</a><br />
            }
        }
        else
        {
            @Html.ActionLink("Buscar no Mapa", "Index", "CAD_PES_JURIDICA")<br />
            @Html.ActionLink("Sobre", "About", "Home")<br />
            @Html.ActionLink("Contatos", "Contact", "Home")<br />
            @Html.ActionLink("Criar Conta", "Register", "Account", routeValues: null, htmlAttributes: new { id = "registerLink" })<br />
            @Html.ActionLink("Entrar", "Login", "Account", routeValues: null, htmlAttributes: new { id = "loginLink" })<br />
        }
    </div>


    <div class="input-group" id="adv-search">
        <form class="form-horizontal" id="searchgroup" action="~/CAD_PES_JURIDICA/Pesquisa" method="get" role="form">
            @*<div class="input-group-addon" id="boxhamburguermap"><span class="opennav" id="hamburguermap" onclick="openNav()">&#9776;</span></div>*@
            <span class="glyphicon glyphicon-menu-hamburger" id="boxhamburguermap" onclick="openNav()"></span>
            <input type="text" class="form-control" name="pesquisa" placeholder="Costureira, Chaveiro, Eletricista">
            <input type="text" id="lat" class="hidden" name="lat">
            <input type="text" id="lng" class="hidden" name="lng">
            <div class="input-group-btn">
                <div class="btn-group" role="group">
                    <div class="dropdown dropdown-lg">
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>
                        <div class="dropdown-menu dropdown-menu-right" id="menudropdown" role="menu">
                            <div class="form-group">
                                <input class="form-control" type="text" />
                            </div>
                            <div class="form-group">
                                <input class="form-control" id="autocomplete" placeholder="Digite um outro endereço"
                                       onFocus="geolocates()" type="text">

                            </div>
                            <button type="submit" class="btn btn-primary" id="lupaAvancada"><span class="glyphicon glyphicon-search" aria-hidden="true" id="lupa"></span></button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary"><span class="glyphicon glyphicon-search" aria-hidden="true" id="lupa"></span></button>
                </div>
            </div>
        </form>
    </div>

    @*<form class="form-inline" id="searchgroup" action="~/CAD_PES_JURIDICA/Pesquisa" method="get">
            <div class="form-group" id="form-group">
                <div class="input-group" id="container-search2">
                    <div class="input-group-addon" id="boxhamburguermap"><span class="opennav" id="hamburguermap" onclick="openNav()">&#9776;</span></div>
                    <input type="text" class="form-control" id="barrapesquisa" name="pesquisa" placeholder="Costureira, Chaveiro, Eletricista">

                    <input type="text" id="lat" class="hidden" name="lat">
                    <input type="text" id="lng" class="hidden" name="lng">

                    <input type="submit" class="pesquisa-avancada-button" value="A">
                    <input type="submit" class="btn btn-default" id="buttonsearch" value="Buscar">


                </div>

                <div id="busca-avancada">
                    <div id="locationField">
                        <input id="autocomplete" placeholder="Digite um outro endereço"
                               onFocus="geolocates()" type="text"></input>
                    </div>
                </div>
            </div>

        </form>*@

    <div id="map">
    </div>
    <script>

        var placeSearch, autocomplete;
        var componentForm = {
            lat: 'lat',
            lng: 'lng'
        };

        // [START region_fillform]
        function fillInAddress() {
            // Get the place details from the autocomplete object.
            var place = autocomplete.getPlace();

            for (var component in componentForm) {
                document.getElementById(component).value = '';
                document.getElementById(component).disabled = false;
            }

            // Get each component of the address from the place details
            // and fill the corresponding field on the form.
            for (var i = 0; i < place.address_components.length; i++) {
                var addressType = place.address_components[i].types[0];
                if (componentForm[addressType]) {
                    var val = place.address_components[i][componentForm[addressType]];
                    document.getElementById(addressType).value = val;
                }
            }
            var lat = place.geometry.location.lat();
            var lng = place.geometry.location.lng();
            document.getElementById("lat").value = lat;
            document.getElementById("lng").value = lng;
        }
        // [END region_fillform]

        // [START region_geolocation]
        // Bias the autocomplete object to the user's geographical location,
        // as supplied by the browser's 'navigator.geolocation' object.
        function geolocates() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var geolocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    var circle = new google.maps.Circle({
                        center: geolocation,
                        radius: position.coords.accuracy
                    });
                    autocomplete.setBounds(circle.getBounds());
                });
            }
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 14,
                center: { lat: -15.7217174, lng: -48.0783226 },
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
            setMarkers(map);

            autocomplete = new google.maps.places.Autocomplete(
            (document.getElementById('autocomplete')),
            { types: ['geocode'] });

            // When the user selects an address from the dropdown, populate the address
            // fields in the form.
            autocomplete.addListener('place_changed', fillInAddress);
        }

        function setMarkers(map) {
            var image2 = {
                url: '/Imagens/Pointer-You.png',
                // This marker is 20 pixels wide by 32 pixels high.
                scaledSize: new google.maps.Size(45, 45),
                // The origin for this image is (0, 0).
                origin: new google.maps.Point(0, 0),
                // The anchor for this image is the base of the flagpole at (0, 32).
                anchor: new google.maps.Point(0, 32)
            };

            var image1 = {
                url: '/Imagens/place-128.png',
                // This marker is 20 pixels wide by 32 pixels high.
                scaledSize: new google.maps.Size(32, 32),
                // The origin for this image is (0, 0).
                origin: new google.maps.Point(0, 0),
                // The anchor for this image is the base of the flagpole at (0, 32).
                anchor: new google.maps.Point(0, 32)
            };

            var infowindow = new google.maps.InfoWindow(), marker;
            @if(ViewBag.latitude == null)
            {
                <text>
            if (navigator.geolocation)
            {

                navigator.geolocation.getCurrentPosition(function(position) {
                    var pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    document.getElementById("lat").value = position.coords.latitude;
                    document.getElementById("lng").value = position.coords.longitude;

                    var posicaoatual = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    map.setCenter(pos);
                    var marker = new google.maps.Marker({
                        map: map,
                        icon: image2,
                        draggable: true,
                    });
                    marker.setPosition(posicaoatual);
                    var infowindow = new google.maps.InfoWindow(), marker;
                    google.maps.event.addListener(marker, 'click', (function(marker, i) {
                        return function() {
                            infowindow.setContent("Você está aqui!");
                            infowindow.open(map, marker);
                        }
                    })(marker))
                }, function() {
                    handleLocationError(true, infoWindow, map.getCenter());
                });
            } else {
                handleLocationError(false, infoWindow, map.getCenter());
            }
            </text>
            }
            else
            {
                 <text>
            var pos = {
                lat: @ViewBag.latitude.ToString().Replace(",", "."),
                lng: @ViewBag.longitude.ToString().Replace(",", "."),
            };

            document.getElementById("lat").value = @ViewBag.latitude.ToString().Replace(",", ".");
            document.getElementById("lng").value = @ViewBag.longitude.ToString().Replace(",", ".");

            var posicaoatual = new google.maps.LatLng(@ViewBag.latitude.ToString().Replace(",", "."), @ViewBag.longitude.ToString().Replace(",", "."));
            map.setCenter(pos);
            var marker = new google.maps.Marker({
                map: map,
                icon: image2,
                draggable: true,
            });
            marker.setPosition(posicaoatual);
            var infowindow = new google.maps.InfoWindow(), marker;
            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    infowindow.setContent("Este é seu ponto de referência!");
                    infowindow.open(map, marker);
                }
            })(marker))

            var markers=[];
            </text>
                    foreach (var item in Model)
                    {
                        var teste = "";

                            <text>
            var marker1 = new google.maps.Marker({
                position: new google.maps.LatLng(@item.CAD_PESSOA.CAD_PES_ENDERECO.Single().localizacao.Longitude.ToString().Replace(",", "."), @item.CAD_PESSOA.CAD_PES_ENDERECO.Single().localizacao.Latitude.ToString().Replace(",", ".")),
                map: map,
                icon: image1,
            });
                        google.maps.event.addListener(marker1, 'click', (function(marker1, i) {
                return function() {
                    var distancia = parseInt((@item.localizacao.Distance(DbGeography.FromText("POINT("+ ViewBag.latitude.ToString().Replace(",", ".") + " "+ ViewBag.longitude.ToString().Replace(",", ".") + ")")).ToString().Replace(",", ".")/0.62137)/1000, 10);
                    infowindow.setContent("<button type='button' class='btn btn-primary btn-xs' data-toggle='modal' data-target='#myModal"+'@item.CAD_PESSOA.DS_APELIDO_SITE'+"'>Acessar mais informações!</button>"+
                        "<br><br>Distância: "+ distancia +" Km"+
                        "<br>"+
                        "Aceita as seguintes formas de pagamento:"+
                        "<br>"+
                        @if(item.CAD_PESSOA.CAD_PES_JURIDICA.CAD_FORMA_PAGAMENTO.DINHEIRO == true)
                        {
                            teste = "'Cheque <br>'+";
                    }
                    "<%= HttpUtility.HtmlEncode("+@teste+") %>"
                        "<br>"+"@item.CAD_PESSOA.UserName"+
                        "<br>"+"Aceita Cartões de crédito e débito"+
                        "<br>"+"atende 7 dias da semana 24h por dia"+
                        "<br>"+"Acionamento direto"+
                        "<br><br>"+
                        "<button type='button' class='btn btn-primary btn-xs' data-toggle='modal' data-target='#myModalAvaliacao"+'@item.CAD_PESSOA.DS_APELIDO_SITE'+"'>Avaliar o Prestador!</button>"+"<br><br>");
                    infowindow.open(map, marker1);
                }
            })(marker1))
            markers.push(marker1);
            </text>
                        }
                    <text>
            var markerCluster = new MarkerClusterer(map, markers, {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
            </text>
            }
        }
    </script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAn0UNBMx1dKf0NQc2pVReLPRo21Eyp8qA&signed_in=true&libraries=places&callback=initMap" async defer></script>
    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")
</body>
</html>


@if (Model == null)
{

}
else
{
    foreach (var item in Model)
    {
        var idmodal = "myModal" + @item.CAD_PESSOA.DS_APELIDO_SITE;
        <div class="modal fade" id='@idmodal' tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">@item.CAD_PESSOA.NM_NOME_PESSOA</h4>
                    </div>
                    <div class="modal-body">
                        @item.CAD_PESSOA.CAD_PES_ENDERECO.Single().NM_LOGRADOURO
                        <br />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        var idavaliacao = "myModalAvaliacao" + @item.CAD_PESSOA.DS_APELIDO_SITE;
        <div class="modal fade" id='@idavaliacao' tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">@item.CAD_PESSOA.NM_NOME_PESSOA</h4>
                    </div>
                    <div class="modal-body">
                        <form class="formAvaliacao form-inline" action="~/Avaliacao/Create" method="post">
                            <div class="input-group">
                                <div class="form-group">
                                    <label class="control-label col-md-2" for="ORGANIZACAO">Organização</label>
                                    <div class="col-md-10">
                                        <div class="btn-group" data-toggle="buttons">
                                            <label class="btn btn-xs btn-success  active">
                                                <input type="radio" name="ORGANIZACAO" id="ORGANIZACAO" value="1" autocomplete="off" chacked>
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-primary">
                                                <input type="radio" name="ORGANIZACAO" id="ORGANIZACAO" value="2" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-default">
                                                <input type="radio" name="ORGANIZACAO" id="ORGANIZACAO" value="3" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-warning">
                                                <input type="radio" name="ORGANIZACAO" id="ORGANIZACAO" value="4" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-danger">
                                                <input type="radio" name="ORGANIZACAO" id="ORGANIZACAO" value="5" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-2" for="PRECO_QUALIDADE">Preço/Qualidade do Serviço</label>
                                    <div class="col-md-10">
                                        <div class="btn-group" data-toggle="buttons">
                                            <label class="btn btn-xs btn-success btn-gradient active">
                                                <input type="radio" name="PRECO_QUALIDADE" id="PRECO_QUALIDADE" value="1" autocomplete="off" chacked>
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-primary">
                                                <input type="radio" name="PRECO_QUALIDADE" id="PRECO_QUALIDADE" value="2" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-default">
                                                <input type="radio" name="PRECO_QUALIDADE" id="PRECO_QUALIDADE" value="3" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-warning">
                                                <input type="radio" name="PRECO_QUALIDADE" id="PRECO_QUALIDADE" value="4" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-danger">
                                                <input type="radio" name="PRECO_QUALIDADE" id="PRECO_QUALIDADE" value="5" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-2" for="PONTUALIDADE">Pontualidade</label>
                                    <div class="col-md-10">
                                        <div class="btn-group" data-toggle="buttons">
                                            <label class="btn btn-xs btn-success btn-gradient active">
                                                <input type="radio" name="PONTUALIDADE" id="PONTUALIDADE" value="1" autocomplete="off" chacked>
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-primary">
                                                <input type="radio" name="PONTUALIDADE" id="PONTUALIDADE" value="2" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-default">
                                                <input type="radio" name="PONTUALIDADE" id="PONTUALIDADE" value="3" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-warning">
                                                <input type="radio" name="PONTUALIDADE" id="PONTUALIDADE" value="4" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-danger">
                                                <input type="radio" name="PONTUALIDADE" id="PONTUALIDADE" value="5" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-2" for="INDICACAO">Você o Indicaria?</label>
                                    <div class="col-md-10">
                                        <div class="btn-group" data-toggle="buttons">
                                            <label class="btn btn-xs btn-success btn-gradient active">
                                                <input type="radio" name="INDICACAO" id="INDICACAO" value="1" autocomplete="off" chacked>
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-primary">
                                                <input type="radio" name="INDICACAO" id="INDICACAO" value="2" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-default">
                                                <input type="radio" name="INDICACAO" id="INDICACAO" value="3" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-warning">
                                                <input type="radio" name="INDICACAO" id="INDICACAO" value="4" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                            <label class="btn btn-xs btn-danger">
                                                <input type="radio" name="INDICACAO" id="INDICACAO" value="5" autocomplete="off">
                                                <span class="glyphicon glyphicon-ok"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label col-md-2" for="DS_DESCRICAO">Descrição</label>
                                    <div class="col-md-10">
                                        <textarea class="form-control" name="DS_DESCRICAO" id="DS_DESCRICAO" rows="3" placeholder="Um breve texto para expor sua opinião..."></textarea>
                                    </div>
                                </div>

                                <input type="text" id="CD_PES_JURIDICA" class="hidden" name="CD_PES_JURIDICA" value="@item.CD_PESSOA">
                                <input type="text" id="CD_PES_USUARIO" class="hidden" name="CD_PES_USUARIO" value="@User.Identity.GetUserId()">
                                @if (Request.IsAuthenticated)
                                {
                                    <div class="col-md-offset-2 col-md-10">
                                        <input type="submit" value="Avaliar" class="btn btn-default" />
                                    </div>
                                }
                                else
                                {
                                    //Html.RenderPartial("_LoginPartial");
                                    <a id="loginparaavaliar" href="~/Account/Login">Faça login para avaliar</a>

                                }
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    }
}